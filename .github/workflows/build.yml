name: 'Build Arkdep Images and Upload'

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 5 * * *'  # Runs at 5 AM UTC daily

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        edition: [arkanelinux, test-arkanelinux-kde]  # Build both images

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install dependencies
      shell: bash
      run: |
        sudo apt update
        sudo apt install -y git build-essential fakeroot squashfs-tools dosfstools btrfs-progs zstd libarchive-tools
        sudo apt install -y arch-install-scripts  # Install pacstrap

    - name: Install arkdep
      shell: bash
      run: |
        git clone --depth 1 https://github.com/arkanelinux/arkdep.git
        sudo install -m755 arkdep/arkdep /usr/bin/
        sudo install -m755 arkdep/arkdep-build /usr/bin/

    - name: Clone variants repo
      shell: bash
      run: |
        git clone --depth 1 https://github.com/silverhadch/arkdep-variants.git arkdep-variants

    - id: build
      name: Build variant
      shell: bash
      run: |
        mkdir -p target
        cd arkdep-variants
        sudo arkdep-build ${{ matrix.edition }}
        ARTIFACT="$(realpath ../target/*.tar.zst)"
        echo "artifact-path=$ARTIFACT" >> $GITHUB_OUTPUT

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.edition }}-image
        path: ${{ steps.build.outputs.artifact-path }}

    - name: Clean up old images (optional)
      run: |
        # Assuming the older images are stored in the target directory
        find target -name "*.tar.zst" -type f -mtime +7 -exec rm {} \;  # Deletes images older than 7 days
